<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äì –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f7f7f7; }
    header { background: #4A3F35; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; }
    button { padding: 0.5rem 1rem; background: #4A3F35; color: white; border: none; border-radius: 4px; cursor: pointer; }
    section { margin: 2rem auto; padding: 2rem; background: white; max-width: 600px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    form { display: flex; flex-direction: column; gap: 1rem; }
    input, select { padding: 0.5rem; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc; }
    #price-display { font-weight: bold; }

    #popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #popup.visible {
      display: flex;
    }
    .popup-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
    <a href="index.html"><button type="button">–í—ã–π—Ç–∏</button></a>
  </header>

  <section>
    <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ—à–∞–¥–∏</h2>
    <form id="booking-form" autocomplete="off">
      <input type="text" placeholder="–ò–º—è" name="firstName" required />
      <input type="text" placeholder="–§–∞–º–∏–ª–∏—è" name="lastName" required />
      <input type="tel" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" name="phone" required />
      <input type="email" placeholder="Email" name="email" required />

      <label for="horse-select">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å:</label>
      <select id="horse-select" required>
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ—à–∞–¥—å --</option>
        <option value="1">–ë—É—Ü–µ—Ñ–∞–ª</option>
        <option value="2" disabled style="color:gray;">–ì—Ä–æ–º (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)</option>
        <option value="3">–ú–æ–ª–Ω–∏—è</option>
      </select>

      <label for="date">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:</label>
      <input type="text" id="date" required />

      <p id="price-display">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span>0</span> ‚ÇΩ</p>
      <button id="submit-booking" type="submit" disabled>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    </form>
  </section>

  <div id="popup">
    <div class="popup-content">
      <p id="popup-message"></p>
      <button id="popup-ok-button">–û–∫</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const horseSelect = document.getElementById('horse-select');
    const dateInput = document.getElementById('date');
    const priceDisplay = document.querySelector('#price-display span');
    const submitBtn = document.getElementById('submit-booking');
    const form = document.getElementById('booking-form');
    const popup = document.getElementById('popup');
    const popupMessage = document.getElementById('popup-message');
    const popupOkButton = document.getElementById('popup-ok-button');
    let flatpickrInstance;

    function updatePrice() {
      const date = dateInput.value;
      const horse = horseSelect.value;
      if (date && horse) {
        const basePrice = 1500;
        const d = new Date(date);
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        const price = isWeekend ? basePrice * 1.2 : basePrice;
        priceDisplay.textContent = price.toFixed(0);
        submitBtn.disabled = false;
      } else {
        priceDisplay.textContent = 0;
        submitBtn.disabled = true;
      }
    }

    async function fetchAndDisableBookedDates(horseId) {
      const res = await fetch(`http://localhost:3000/booked-dates/${horseId}`);
      const data = await res.json();

      if (flatpickrInstance) {
        flatpickrInstance.destroy();
      }

      flatpickrInstance = flatpickr(dateInput, {
        dateFormat: "Y-m-d",
        disable: data.bookedDates,
        onChange: updatePrice,
        minDate: "today"
      });
    }

    horseSelect.addEventListener("change", async () => {
      const horseId = horseSelect.value;
      if (horseId) {
        await fetchAndDisableBookedDates(horseId);
        updatePrice();
      }
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      e.stopImmediatePropagation(); // üí• –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

      const body = {
        horse_id: horseSelect.value,
        horse_name: horseSelect.options[horseSelect.selectedIndex].text,
        date: dateInput.value,
        first_name: form.firstName.value,
        last_name: form.lastName.value,
        phone: form.phone.value,
        email: form.email.value
      };

      try {
        const res = await fetch('http://localhost:3000/book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await res.json();

        if (res.ok) {
          popupMessage.innerHTML = `–õ–æ—à–∞–¥—å <strong>${body.horse_name}</strong> —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞.<br>–°—Ç–æ–∏–º–æ—Å—Ç—å: <strong>${priceDisplay.textContent} ‚ÇΩ</strong><br>–° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º.`;
          popup.classList.add('visible');
        } else {
          alert(result.error || "–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è");
        }
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
        console.error(err);
      }
    });

    popupOkButton.addEventListener('click', () => {
      popup.classList.remove('visible');   // –ø—Ä—è—á–µ–º –ø–æ–ø‚Äë–∞–ø
      window.location.href = 'index.html'; // —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    });

    // –ï—Å–ª–∏ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –ª–æ—à–∞–¥—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —ç–∫—Ä–∞–Ω–µ
    const selectedHorseName = localStorage.getItem('selectedHorseName');
    if (selectedHorseName) {
      for (let opt of horseSelect.options) {
        if (opt.textContent.includes(selectedHorseName) && !opt.disabled) {
          horseSelect.value = opt.value;
          horseSelect.dispatchEvent(new Event('change'));
          break;
        }
      }
      localStorage.removeItem('selectedHorseName');
    }
  </script>
</body>
</html>

name: Test and Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:v0.12.0

    - name: üß± Create Docker network
      run: docker network create horse-net
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
    - name: üîç Check required files
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ ==="
        ls -la
        echo ""
        echo "=== Dockerfile ==="
        if [ -f "Dockerfile" ]; then
          echo "‚úÖ Dockerfile –Ω–∞–π–¥–µ–Ω"
          head -5 Dockerfile
        else
          echo "‚ùå Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
        echo ""
        echo "=== Dockerfile.test ==="
        if [ -f "Dockerfile.test" ]; then
          echo "‚úÖ Dockerfile.test –Ω–∞–π–¥–µ–Ω"
          head -5 Dockerfile.test
        else
          echo "‚ùå Dockerfile.test –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Docker —Å–ª–æ–µ–≤
    - name: üîß Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-
    
    # C–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    - name: üî® Build containers
      run: |
        echo "=== –°–±–æ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="
        docker buildx build --platform linux/amd64 \
            -t horse-booking-app . \
            --load
        
        echo "=== –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ==="
        docker buildx build --platform linux/amd64 \
            -t test-runner -f Dockerfile.test \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load .
        
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫—ç—à
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏
    - name: üê≥ List Docker images
      run: |
        echo "=== –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤ ==="
        docker images
        echo ""
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ ==="
        docker images | grep horse-booking-app || echo "‚ùå horse-booking-app NOT built"
        docker images | grep test-runner || echo "‚ùå test-runner NOT built"

    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - name: üöÄ Start application
      run: |
        docker run -d --name horse-booking \
          --network horse-net \
          -p 3000:3000 \
          --health-cmd="curl -f http://0.0.0.0:3000 || exit 1" \
          --health-interval=5s \
          --health-timeout=3s \
          --health-retries=5 \
          horse-booking-app
        
        # –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        timeout -s TERM 60 bash -c 'until docker inspect horse-booking --format="{{.State.Health.Status}}" | grep -q healthy; do sleep 2; done'
        echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ"
    
    # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    - name: üîç Debug network connectivity
      run: |
        echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ ==="
        docker ps -a | grep horse-booking
        docker logs horse-booking | tail -10
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏ ==="
        docker network inspect horse-net
        
        echo "=== –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ==="
        docker run --rm --network horse-net \
          alpine/curl:latest \
          curl -v -m 5 http://horse-booking:3000 || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
    
    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    - name: üß™ Run tests
      run: |
        mkdir -p allure-results
        chmod -R 777 allure-results
        
        docker run --rm \
          --network horse-net \
          -v $(pwd)/allure-results:/tests/allure-results \
          -e BASE_URL=http://horse-booking:3000 \
          test-runner
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
    - name: üìà Generate report
      if: always()
      run: |
        mkdir -p allure-report
        chmod -R 777 allure-report
        
        if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Docker –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
          docker run --rm \
            -v $(pwd)/allure-results:/allure-results \
            -v $(pwd)/allure-report:/allure-report \
            frankescobar/allure-docker-service:latest \
            allure generate /allure-results -o /allure-report --clean
        else
          mkdir -p allure-report
          echo "<h1>No test results found</h1>" > allure-report/index.html
        fi
    
    - name: üì§ Upload report
      uses: actions/upload-pages-artifact@v3
      if: always()
      with:
        path: allure-report/
    
    - name: üßπ Cleanup
      if: always()
      run: |
        docker stop horse-booking || true
        docker rm horse-booking || true

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: üåê Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4